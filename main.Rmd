---
title: "main"
output: html_document
---


```{r}
pacman::p_load(tidyverse,
               readxl)
```

# Antiguas bases de datos
```{r, warning=FALSE, message=FALSE}
Crashes_Of_Airplanes <- read_excel("data/Crashes_Of_Airplanes.xlsx")
ICAO_accidents <- read_csv("data/ICAO_accidents.csv")
ICAO_accidents <- ICAO_accidents %>% select(-1)
ICAO_accidents$Date <- ymd(gsub("T00:00:00.000Z","", ICAO_accidents$Date ))
ICAO_accidents <- ICAO_accidents %>% select(-c(2, 7:10, 12:18, 21:22, 24))
Crashes_Of_Airplanes <- Crashes_Of_Airplanes %>% select(-c(2,5,6,13))
Crashes_Of_Airplanes <- Crashes_Of_Airplanes %>% mutate(
  Fatalities = Fatalities + Ground
)
ICAO_accidents <- ICAO_accidents %>% select(-7,-8,-9)
Crashes_Of_Airplanes <- Crashes_Of_Airplanes %>% select(1,2,4,5,3,8)
names(Crashes_Of_Airplanes) <- names(ICAO_accidents)

data <- rbind(Crashes_Of_Airplanes, ICAO_accidents)
rm(ICAO_accidents, Crashes_Of_Airplanes)
```

# Base completa
```{r}
data <- read_csv("data/aircrahesFullDataUpdated_2024.csv")
names(data)[11] <- "Fatalities"
data <- data %>% mutate(
  all_fatal = Ground + Fatalities,
  tasa_muertes = Fatalities/Aboard)
data <- data[data$tasa_muertes != Inf,]
data <- data[!is.na(data$tasa_muertes),]

```


# GLM
```{r}
data <- data %>%
  mutate(Operator = case_when(
    str_detect(tolower(Operator), "air") ~ "Comercial",
    str_detect(tolower(Operator), "military|force|navy") ~ "Militar",
    TRUE ~ "Otro"
  ))
```


```{r}
mod.poisson <- glm(Fatalities ~ Operator, 
                      data = data, family = poisson)
summary(mod.poisson)
```

```{r}
dispersion <- sum(residuals(mod.poisson, type = "pearson")^2) / df.residual(mod.poisson)
dispersion
```


```{r}
library(MASS)
modelo_nb <- glm.nb(Fatalities ~ Operator, data = data)
summary(modelo_nb)
```

# Primas

```{r}
data <- data %>% mutate(
  costo_aviones = 100e6 * 1.05**(-(2024-data$Year)),
  costo_vidas = data$Fatalities * 2.1e6 * 1.05**(-(2024-data$Year))
)

qx <- sum(data$Year == 2024)/1e6 # 43.8e6
mean_fatal <- mean(data$Fatalities,na.rm = T)

# Costo de asegurar un avi칩n a 100 a침os

ins_aviones <- sum(sapply(1:100, function(x) qx*(1-qx)**(x-1)*100e6*1.05**(-x+1)))


# Costo de asegurar las personas que mueren en el avi칩n a 100 a침os

ins_vidas <- sum(sapply(1:100, function(x) qx*(1-qx)**(x-1)*mean_fatal*2.1e6*1.05**(-x+1)))

# Prima nivelada

an <- (1-1.05^-100)/0.05
(prima <- (ins_aviones+ins_vidas)/an)
```


