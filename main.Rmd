---
title: "main"
output: html_document
---


```{r}
pacman::p_load(tidyverse, 
               dplyr, 
               readxl, 
               ggplot2)
```

# Base de datos
```{r message=FALSE, warning=FALSE}
data <- read_csv("data/aircrahesFullDataUpdated_2024.csv")
names(data)[11] <- "Fatalities"
data <- data %>% mutate(all_fatal = Ground + Fatalities,
                        tasa_muertes = Fatalities / Aboard)
data <- data[data$tasa_muertes != Inf, ]
data <- data[!is.na(data$tasa_muertes), ]
```

```{r}
top.aircrafts <- data %>% 
  count(Aircraft, sort = TRUE) %>% 
  slice_max(n, n = 100)

top20.aircrafts <- top.aircrafts %>% slice_max(n, n = 20)
ggplot(top20.aircrafts, aes(x = reorder(Aircraft, n), y = n)) +
  geom_col(fill = 'lightblue4') +
  coord_flip() +
  labs(x = "Aeronave", y = "Frecuencia")
```


# GLM
```{r}
data <- data %>%
  mutate(Operator = case_when(
    str_detect(tolower(Operator), "air") ~ "Comercial",
    str_detect(tolower(Operator), "military|force|navy") ~ "Militar",
    TRUE ~ "Otro"
  ))
```


```{r}
mod.poisson <- glm(Fatalities ~ Operator, 
                      data = data, family = poisson)
summary(mod.poisson)
```

```{r}
dispersion <- sum(residuals(mod.poisson, type = "pearson")^2) / df.residual(mod.poisson)
dispersion
```


```{r}
library(MASS)
modelo_nb <- glm.nb(Fatalities ~ Operator, data = data)
summary(modelo_nb)
```

# Primas

```{r}
data <- data %>% mutate(
  costo_aviones = 100e6 * 1.05**(-(2024-data$Year)),
  costo_vidas = data$Fatalities * 2.1e6 * 1.05**(-(2024-data$Year))
)

qx <- sum(data$Year == 2024)/1e6 # 43.8e6
mean_fatal <- mean(data$Fatalities,na.rm = T)

# Costo de asegurar un avi칩n a 100 a침os

ins_aviones <- sum(sapply(1:100, function(x) qx*(1-qx)**(x-1)*100e6*1.05**(-x+1)))


# Costo de asegurar las personas que mueren en el avi칩n a 100 a침os

ins_vidas <- sum(sapply(1:100, function(x) qx*(1-qx)**(x-1)*mean_fatal*2.1e6*1.05**(-x+1)))

# Prima nivelada

an <- (1-1.05^-100)/0.05
(prima <- (ins_aviones+ins_vidas)/an)
```


